---
// src/layouts/Layout.astro
import "../styles/global.css";

const {
  title,
  description = "業界特化の転職支援サービス。年収アップとキャリアの最適化を支援します。",
  bodyClass = "",
  keywords = [],
  colors = {
    primary: '#00A968',
    secondary: '#ffffff',
    accent: '#F39C12',
    txtMain: '#333333',
    link: '#0b62e5',
  },
  showHeader = false,
  canonical,
  ogImage,
} = Astro.props;

const GTM_ID = "GTM-5PW3KRHH";
---

<!doctype html>
<html lang="ja" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    {canonical && <link rel="canonical" href={canonical} />}

    <!-- OGP / SNS Share Settings -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={canonical || Astro.url} />
    {ogImage && <meta property="og:image" content={ogImage} />}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImage && <meta name="twitter:image" content={ogImage} />}

    <link rel="icon" href="/assets/images/favicon.ico" />
    
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="manifest" href="/assets/images/manifest.json" />

    {import.meta.env.PROD && (
      <script is:inline define:vars={{ GTM_ID }}>
        (function (w, d, s, l, i) {
          w[l] = w[l] || [];
          w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
          var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != "dataLayer" ? "&l=" + l : "";
          j.async = true;
          j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
          f.parentNode.insertBefore(j, f);
        })(window, document, "script", "dataLayer", GTM_ID);
      </script>
    )}
  </head>

  <body class={bodyClass} style={`
    --color-primary: ${colors.primary};
    --color-secondary: ${colors.secondary};
    --color-accent: ${colors.accent};
    --color-txt-main: ${colors.txtMain};
    --color-link: ${colors.link};
  `}>
    {import.meta.env.PROD && (
      <noscript><iframe src={`https://www.googletagmanager.com/ns.html?id=${GTM_ID}`} height="0" width="0" style="display: none; visibility: hidden"></iframe></noscript>
    )}
    
    {showHeader && (
      <header class="py-6 px-4 border-b border-gray-100 bg-white">
        <div class="max-w-4xl mx-auto">
          <a href="/" class="inline-block hover:opacity-80 transition-opacity">
            <img src="/assets/images/logo.svg" alt="Match Box" class="h-8 md:h-10 w-auto" />
          </a>
        </div>
      </header>
    )}

    <slot />

    <footer class="bg-[#1e3a5f] text-[#E0F2FE] py-12 px-4 mt-auto">
      <div class="max-w-4xl mx-auto flex flex-col items-center gap-6 text-sm text-center">
        <div>
          <div class="font-bold text-xl text-white tracking-wider flex justify-center">
            <img src="/assets/images/logo_wh.svg" alt="Match Box" class="h-16 w-auto" />
          </div>
          <p class="text-xs mt-2 opacity-80">あなたの世界に、新しい可能性を。</p>
        </div>
        <div>
          <div class="mt-2 space-x-6 text-xs font-medium">
            <a href="/company/" class="hover:text-white transition">運営者情報</a>
            <a href="/privacy/" class="hover:text-white transition">プライバシーポリシー</a>
          </div>
        </div>
      </div>
      <div class="text-center text-[10px] text-[#94a3b8] mt-12 border-t border-[#334155] pt-8">
        &copy; {new Date().getFullYear()} Match Box. All Rights Reserved.
      </div>
    </footer>

    {keywords && keywords.length > 0 && (
      <script define:vars={{ keywords }}>
        const initKeywords = () => {
          const articles = document.querySelectorAll('.prose');
          if (articles.length === 0) return;

          const sortedKeywords = [...keywords].sort((a, b) => b.text.length - a.text.length);
          const regexParts = sortedKeywords.map(kw => kw.text.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'));
          if (regexParts.length === 0) return;
          
          const masterRegex = new RegExp(`(${regexParts.join('|')})`, 'g');

          articles.forEach(article => {
            const walker = document.createTreeWalker(article, NodeFilter.SHOW_TEXT, {
              acceptNode: (node) => {
                let parent = node.parentElement;
                while (parent && parent !== article) {
                  const tagName = parent.tagName.toLowerCase();
                  if (['a', 'script', 'style', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'button', 'textarea', 'input'].includes(tagName)) {
                    return NodeFilter.FILTER_REJECT;
                  }
                  parent = parent.parentElement;
                }
                return NodeFilter.FILTER_ACCEPT;
              }
            });

            const nodesToProcess = [];
            let currentNode;
            while (currentNode = walker.nextNode()) {
              masterRegex.lastIndex = 0;
              if (masterRegex.test(currentNode.nodeValue)) {
                nodesToProcess.push(currentNode);
              }
            }

            nodesToProcess.forEach(node => {
              const text = node.nodeValue;
              const fragment = document.createDocumentFragment();
              let lastIndex = 0;

              masterRegex.lastIndex = 0;
              text.replace(masterRegex, (match, ...args) => {
                const offset = args[args.length - 2];
                if (offset > lastIndex) {
                  fragment.appendChild(document.createTextNode(text.substring(lastIndex, offset)));
                }
                const matchedKeyword = sortedKeywords.find(kw => kw.text === match);
                const link = document.createElement('a');
                link.href = matchedKeyword.link;
                link.textContent = match;
                link.className = 'keyword-link';
                fragment.appendChild(link);
                lastIndex = offset + match.length;
              });

              if (lastIndex < text.length) {
                fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
              }
              node.parentNode.replaceChild(fragment, node);
            });
          });
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initKeywords);
        } else {
          initKeywords();
        }
      </script>
    )}

    <style is:global>
      @font-face {
        font-family: 'LINE Seed JP';
        src: url('https://cdn.jsdelivr.net/gh/kemat/line-seed-jp-webfont@main/fonts/LINESeedJP_OTF-Regular.woff2') format('woff2');
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: 'LINE Seed JP';
        src: url('https://cdn.jsdelivr.net/gh/kemat/line-seed-jp-webfont@main/fonts/LINESeedJP_OTF-Bold.woff2') format('woff2');
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: 'LINE Seed JP';
        src: url('https://cdn.jsdelivr.net/gh/kemat/line-seed-jp-webfont@main/fonts/LINESeedJP_OTF-ExtraBold.woff2') format('woff2');
        font-weight: 800;
        font-style: normal;
        font-display: swap;
      }

      body {
        font-family: "LINE Seed JP", "Helvetica Neue", Arial, sans-serif !important;
      }
      .template-wrapper, .prose {
        font-family: "LINE Seed JP", sans-serif !important;
      }

      .prose h2 {
        font-size: 1.3rem;
        font-weight: 600;
        color: #ffffff;
        position: relative;
        padding: 1.5rem 1rem;
        text-align: center;
        margin-top: 4rem;
        margin-bottom: 2rem;
        line-height: 1.3;
        letter-spacing: -0.02em;
        background: linear-gradient(to right, #000000, var(--color-primary), var(--color-accent));
        text-wrap: balance;
        font-feature-settings: "palt";
      }

      .prose h2:first-child {
        margin-top: 0;
      }

      .prose h3 {
        font-size: 1.4rem;
        font-weight: 700;
        color: color-mix(in srgb, var(--color-primary), black 30%);
        margin-top: 3rem;
        margin-bottom: 1.25rem;
        padding: 0.25rem 0 0.25rem 1rem;
        border-bottom: 2px solid #e2e8f0;
        letter-spacing: -0.01em;
        font-feature-settings: "palt";
      }
      .prose h4 {
        font-size: 1.2rem;
        font-weight: 700;
        color: color-mix(in srgb, var(--color-primary), black 30%);
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        font-feature-settings: "palt";
      }
      .prose p { 
        margin-bottom: 1.75rem; 
        text-align: justify; 
      }
      .prose strong {
        color: var(--color-txt-main) !important;
        font-weight: 700 !important; 
        background-image: none !important;
        padding: 0;
      }
      .prose em {
        font-style: normal !important;
        font-weight: 700 !important;
        background-image: linear-gradient(0deg, color-mix(in srgb, var(--color-accent) 50%, transparent) 0.5em, transparent 0.5em) !important;
        padding: 0 4px;
        -webkit-box-decoration-break: clone;
        box-decoration-break: clone;
      }
      .prose ul {
        background-color: color-mix(in srgb, var(--color-primary) 5%, white);
        padding: 1.5rem 1.5rem 1.5rem 1.5rem;
        border-radius: 12px;
        list-style: none;
      }
      .prose ul.with-title {
        padding-top: 4.5rem;
        padding-bottom: 2rem;
        position: relative;
      }
      .prose ul.with-title::before {
        content: attr(data-title);
        position: absolute;
        top: 1.5rem;
        left: 0;
        width: 100%;
        text-align: center;
        font-weight: 700;
        color: var(--color-primary);
      }
      .prose li {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
        padding-left: 1.5rem;
        position: relative;
        font-weight: 700;
        border-bottom: 1px dashed color-mix(in srgb, var(--color-primary) 30%, transparent);
        padding-bottom: 0.5rem;
      }
      .prose li:last-child {
        border-bottom: none;
      }
      .prose li::before {
        content: "\f00c";
        font-family: "Font Awesome 6 Free";
        position: absolute;
        left: 0;
        top: 0.2em;
        color: var(--color-primary);
        font-weight: 900;
      }

      .prose a:not(.cta-button):not(.keyword-link) {
        color: var(--color-link) !important;
        font-weight: 700;
        text-decoration: underline;
        text-decoration-style: dotted;
        text-underline-offset: 4px;
        transition: all 0.3s ease;
      }
      .prose a:not(.cta-button):not(.keyword-link):hover {
        color: var(--color-accent) !important;
        opacity: 0.7;
      }

      .keyword-link,
      .prose .keyword-link,
      .prose strong .keyword-link {
        text-decoration: none !important;
        border-bottom: 1px dashed color-mix(in srgb, var(--color-primary), transparent 50%) !important;
        font-weight: 700;
        color: color-mix(in srgb, var(--color-primary), black 20%) !important;
        cursor: pointer;
        transition: opacity 0.2s;
        position: relative;
        z-index: 1;
      }
      .keyword-link:hover {
        opacity: 0.7;
        color: color-mix(in srgb, var(--color-accent), white 30%) !important;
        border-bottom-color: color-mix(in srgb, var(--color-accent), white 40%) !important;
      }

      .table-scroll {
        margin-bottom: 2rem;
        padding-top: 2rem;
      }
      .table_design13 {
        border-collapse: collapse;
        table-layout: fixed;
        width: 100%;
        font-weight: bold;
        text-align: center;
      }
      .table_design13 thead th {
        padding: 1em .8em;
        border-right: 2px solid #fff;
        text-align: center;
        vertical-align: middle;
      }
      .table_design13 thead th:first-child {
        width: 15%;
      }
      .table_design13 td {
        color: var(--color-primary);
        padding: 1em;
      }
      .table_design13 thead th:not(:first-child) {
        background: var(--color-primary);
        color: #fff;
        font-size: 1.2rem;
        padding: 0.5em;
      }
      .table_design13 thead th span {
        font-size: .8rem;
        display: block;
        font-weight: normal;
      }
      .table_design13 thead th:nth-child(2) {
        background-color: var(--color-accent);
        position: relative;
        transform: scale(1.05);
        z-index: 10;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      .table_design13 thead th:nth-child(2)::before {
        content: '';
        width: 100%;
        height: 10px;
        position: absolute;
        background-color: var(--color-accent);
        left: 0;
        bottom: 100%;
        border-radius: 8px 8px 0 0;
      }
      .table_design13 thead th:nth-child(2)::after {
        content: 'おすすめ';
        width: max-content;
        color: var(--color-accent);
        font-size: .8rem;
        padding: 0.3em 1em;
        background: #fff;
        border: 2px solid var(--color-accent);
        border-radius: 100vh;
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
      }
      .table_design13 tbody th, .table_design13 tbody td {
        border: 2px solid #fff;
      }
      .table_design13 tbody th {
        background-color: color-mix(in srgb, var(--color-primary) 20%, white);
        color: var(--color-primary);
        padding: 1em;
      }
      .table_design13 tbody td {
        background-color: color-mix(in srgb, var(--color-primary) 5%, white);
      }
      .table_design13 td:nth-child(2) {
        color: var(--color-accent);
        background: #fff;
        transform: scale(1.05);
        z-index: 10;
        position: relative;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        outline: 2px solid var(--color-accent);
      }
      .table_design13 thead th:nth-child(3) {
        background-color: #94a3b8;
      }
      .table_design13 td:nth-child(3) {
        color: #334053;
      }

      @media (max-width: 768px) {
        .table-scroll {
          overflow-x: auto;
        }
        .table_design13 {
          min-width: 700px;
        }
        .table_design13 thead th:first-child,
        .table_design13 tbody th {
          font-size: 0.85rem;
          padding-left: 1rem;
        }
        .prose h2 {
          font-size: 1.15rem;       /* 文字を少し小さくして収まりを良くする */
          margin-left: -2rem;       /* 親要素のpadding(p-8=2rem)を打ち消して全幅にする */
          margin-right: -2rem;
          padding: 1.25rem 2rem;    /* 文字位置は元のコンテンツ幅に合わせる */
          text-align: left;         /* 左揃えにして読みやすくする */
          line-height: 1.5;         /* 行間を少し広げて窮屈さを解消 */
          text-wrap: wrap;          /* balanceによる右側の空きを防ぐ */
          overflow-wrap: break-word; /* 長い単語は折り返す */
        }

        .prose h2:first-child {
          margin-top: -2rem;      /* 親要素のpadding-topを打ち消して上にくっつける */
        }

        .prose h3 {
          font-size: 1.1rem;        /* h2とのバランスを見てサイズダウン */
          margin-top: 2rem;         /* 余白も少し詰める */
          text-wrap: wrap;          /* balanceによる右側の空きを防ぐ */
          overflow-wrap: break-word;
        }
        .prose h4 {
          font-size: 1rem;
          margin-top: 1.5rem;
          text-wrap: wrap;
          overflow-wrap: break-word;
        }
      }

      .shiny-effect::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
        transform: skewX(-25deg);
        animation: shine 4s infinite;
        pointer-events: none;
      }
      @keyframes shine {
        0% { left: -100%; }
        20% { left: 200%; }
        100% { left: 200%; }
      }
    </style>
  </body>
</html>