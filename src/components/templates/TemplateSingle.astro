---
// src/components/templates/TemplateSingle.astro
import AffiliateBanner from './AffiliateBanner.astro';
import ArticleCta from './ArticleCta.astro';
import StickyFooter from './StickyFooter.astro';
import BaseLayout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';

const { entry, Content } = Astro.props;
const data = entry.data;

// --- 1. 画像の安全な取得 ---
const mvImage = data.images?.mv || 'https://placehold.jp/1200x630.png?text=No+Image';
const mvAlt = data.images?.mvAlt || 'Main Visual';

// --- 2. Canonical URLの生成 (大文字URLに統一) ---
// 変数名を canonicalURL に統一します
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// --- 3. OGP画像の生成 ---
const ogImage = data.images?.og || mvImage;
let ogImageUrl;
if (typeof ogImage === 'string') {
  ogImageUrl = ogImage.startsWith('http') ? ogImage : new URL(ogImage, Astro.site).href;
} else {
  // オブジェクトの場合は .src を使って絶対URL化
  ogImageUrl = new URL(ogImage.src, Astro.site).href;
}

// --- 4. 配色・リンク設定 ---
const defaultColors = {
  primary: '#1e3a8a',
  secondary: '#eeeeee',
  accent: '#ea580c',
  txtMain: '#333333',
  link: '#2563eb',
};
const colors = { ...defaultColors, ...(data.colors || {}) };
const affiliateLink = `/link/${entry.slug}/`;
const keywords = [
  ...(data.title ? [{ text: data.title, link: affiliateLink }] : []),
  ...(data.keywords || [])
];

const ctaData = data.cta;
const heroCta = data.heroCta || {};
const mvButtonLabel = heroCta.label || data.mvButtonLabel || '公式サイトで詳細を見る';
const mvMicroCopy = heroCta.microCopy || data.mvMicroCopy || '※登録は無料・1分で完了します';
const stickyData = data.sticky || {};

// ★ CVボタンの色を一律緑色に設定 (#00A968)
const cvButtonColor = '#00A968';
---

<BaseLayout 
  title={data.title} 
  description={data.description} 
  colors={colors} 
  keywords={keywords} 
  canonical={canonicalURL} 
  ogImage={ogImageUrl}
>
  <div class="template-wrapper min-h-screen bg-slate-50 text-txt-main md:pb-0">
    
    <section class="relative min-h-[440px] md:min-h-[560px] flex items-start justify-center overflow-hidden pt-[60px] pb-28 md:pt-16 md:pb-40">
      <div class="absolute inset-0 z-0">
        {typeof mvImage === 'string' ? (
          <img src={mvImage} alt={mvAlt} class="w-full h-full object-cover animate-fade-in" />
        ) : (
          <Image src={mvImage} alt={mvAlt} class="w-full h-full object-cover animate-fade-in" loading="eager" />
        )}
        <div class="absolute inset-0 bg-[radial-gradient(#ffffff_1.5px,transparent_1.5px)] [background-size:24px_24px] opacity-20"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-gray-900/95 via-gray-900/60 to-gray-900/30"></div>
        <div class="absolute bottom-0 left-0 w-full h-40 md:h-64 bg-gradient-to-b from-transparent to-slate-50"></div>
      </div>

      <span class="absolute top-3 right-3 z-20 text-[10px] text-white/50 font-medium tracking-wider leading-none border border-white/30 rounded px-1.5 py-0.5">PR</span>

      <div class="relative z-10 container max-w-6xl mx-auto px-6 text-center">
        {data.badge && (
          <p class="text-accent font-bold tracking-[0.2em] uppercase mb-5 text-xs md:text-sm bg-black/30 inline-block px-4 py-1 rounded-full border border-white/10 backdrop-blur-md animate-fade-in-up delay-100">
            {data.badge}
          </p>
        )}
        <h1 class="text-5xl md:text-6xl lg:text-7xl font-extrabold leading-tight mb-6 text-white drop-shadow-md tracking-tighter [text-wrap:balance] [font-feature-settings:'palt'] animate-fade-in-up delay-300" set:html={data.heroTitle || data.title} />
        <p class="text-gray-100 text-base md:text-xl font-medium leading-relaxed max-w-2xl mx-auto tracking-normal opacity-90 mb-0 md:mb-10 animate-fade-in-up delay-500">
          {data.description}
        </p>

        <div id="mv-cta-button" class="inline-block relative group mt-8 md:mt-0 w-full md:w-auto animate-fade-in-up delay-700">
          <a href={affiliateLink} class="relative flex items-center justify-center text-white text-xl md:text-2xl font-bold py-5 px-6 md:px-16 rounded-full shadow-lg hover:opacity-90 transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-2xl w-full md:w-auto md:min-w-[400px]" style={`background-color: ${cvButtonColor}`}>
            <span class="absolute inset-0 rounded-full overflow-hidden shiny-effect"></span>
            <span class="relative z-10 flex items-center justify-center gap-3">
              <span>{mvButtonLabel}</span>
              <i class="fa-solid fa-chevron-right text-lg md:text-xl"></i>
            </span>
          </a>
          <p class="text-xs text-gray-300 mt-3 font-medium tracking-wider">
            {mvMicroCopy}
          </p>
        </div>
      </div>
    </section>

    <main class="relative z-20 px-0 md:px-4 -mt-16 pb-12">
      <div class="max-w-3xl mx-auto">
        <article class="bg-white rounded-none md:rounded-[2rem] shadow-xl overflow-hidden ring-1 ring-black/5">
          <div class="p-8 md:p-14">
             <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed prose-p:tracking-normal">
                <Content />
             </div>
             
             {ctaData && (
               <ArticleCta
                 href={affiliateLink}
                 title={ctaData.title}
                 label={ctaData.label}
                 microCopy={ctaData.microCopy}
                 icon={ctaData.icon}
                 color={cvButtonColor}
               />
             )}
          </div>
        </article>
      </div>
    </main>

    <StickyFooter 
      link={affiliateLink} 
      text={stickyData.text} 
      label={stickyData.label} 
      microCopy={stickyData.microCopy} 
      colors={{ ...colors, accent: cvButtonColor }}
    />
  </div>
</BaseLayout>

<style>
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 2s ease-out forwards;
  }

  .animate-fade-in-up {
    opacity: 0;
    animation: fadeInUp 0.8s ease-out forwards;
  }

  .delay-100 { animation-delay: 0.1s; }
  .delay-300 { animation-delay: 0.3s; }
  .delay-500 { animation-delay: 0.5s; }
  .delay-700 { animation-delay: 0.7s; }
</style>